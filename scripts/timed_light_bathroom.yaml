timed_light_bathroom:
  alias: "Turn on bathroom light and set timer"
  sequence:
    # Cancel ev. old timers
    - service: script.turn_off
      data:
         entity_id: script.timer_off_bathroom
    - service: light.turn_on
      data_template:
        entity_id: light.bathroom_lightswitch_level
        transition: 2
        # brightness set to 3 between 10pm and 7am, 50 between 8pm and 10pm and 255 between 8am and 10pm.
        brightness: >- 
          {%- if now().strftime('%H')|int >=22 -%}
            {{3|int}}
          {%- elif now().strftime('%H')|int >=20 -%}
            {{50|int}}
          {%- elif now().strftime('%H') |int >=8 -%}
            {{255|int}}
          {%- else -%}
            {{20|int}}
          {%- endif -%}
    # Set new timer
    - service: script.turn_on
      data:
        entity_id: script.timer_off_bathroom
timer_off_bathroom:
  alias: "Turn off bathroom light after 30 seconds"
  sequence:
    - delay: 00:00:30
    - service_template: > 
        {% if ((not is_state('sensor.bathroom_sensor_burglar', '0'))) %}
          script.turn_on
        {% else %}
          light.turn_off
        {% endif %}
      data_template:
        entity_id: >
          {% if ((not is_state('sensor.bathroom_sensor_burglar', '0'))) %}
            script.timer_off_bathroom_restart
          {% else %}
            light.bathroom_lightswitch_level
          {% endif %}
timer_off_bathroom_restart:
  alias: "Turn off bathroom light after 30 seconds (restart)"
  sequence:
    # Cancel current script
    - service: script.turn_off
      data:
        entity_id: script.timer_off_bathroom
    # Set new timer
    - service: script.turn_on
      data:
        entity_id: script.timer_off_bathroom